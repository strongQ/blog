import{_ as s,o as a,c as n,U as l}from"./chunks/framework.83a19234.js";const i=JSON.parse('{"title":"IotFun平台","description":"","frontmatter":{},"headers":[],"relativePath":"docs/框架/netcore/IotFun开发框架.md","filePath":"docs/框架/netcore/IotFun开发框架.md","lastUpdated":1701308227000}'),o={name:"docs/框架/netcore/IotFun开发框架.md"},p=l(`<h1 id="iotfun平台" tabindex="-1">IotFun平台 <a class="header-anchor" href="#iotfun平台" aria-label="Permalink to &quot;IotFun平台&quot;">​</a></h1><p>IotFun是一个用net6+vue3.0+grpc+sqlsugar+furion+signalr+iotclient构建的数采平台，包含vue前端、api后端、数采平台（数采服务端、数采客户端、数采web客户端）。</p><h1 id="_1、平台亮点" tabindex="-1">1、平台亮点 <a class="header-anchor" href="#_1、平台亮点" aria-label="Permalink to &quot;1、平台亮点&quot;">​</a></h1><ol><li>平台有独立与web系统之外的数采调度服务端，统筹所有设备数据并分发控制指令。</li><li>数采平台可以部署为windows服务，并且已经用于生产环境中，比较稳定。</li><li>数采客户端可以分布式部署单独绑定设备，数采服务端也可以绑定设备独立运行，适应各种复杂场景。</li><li>自带设备实时日志和历史日志，便于了解设备采集详情。</li><li>数采服务端解耦调度业务，动态加载特有的调度业务。</li><li>集成IotClient，便于扩展采集协议。</li><li>通过表达式可以对数据进行简单处理。</li></ol><h1 id="_2、功能设计" tabindex="-1">2、功能设计 <a class="header-anchor" href="#_2、功能设计" aria-label="Permalink to &quot;2、功能设计&quot;">​</a></h1><ul><li>数采客户端，客户端绑定设备。可以分布式部署多个客户端。</li><li>数采web客户端，可以绑定设备，使用web api与第三方对接。</li><li>数采服务端同时也是调度服务端只有1个，也可以绑定设备，单独使用。</li><li>IotFun类库为admin.web使用，前端界面和业务在其中。</li><li>IotFunClient为采集客户端解决方案文件夹，包含IotClientService（客户端采集服务业务）IotClientConsole（客户端采集程序）、IotClientWeb（其它web客户端）SyncSocketModuleCore等程序集</li><li>IotFunServer为监听服务解决方案文件夹，包含IotContract、IotServer（grpc服务端），IotServerService（服务端操作逻辑、数据库访问等）</li><li>IotProcess为调度程序解决方案文件夹，包含扩展的调度项目，调度和数据处理都在该项目中。生成后部署到ProcessExtensions文件夹中（支持多个项目同时启动）。</li><li>集成SignalR服务，传输各个客户端的日志。</li></ul><h1 id="_3、采集逻辑" tabindex="-1">3、采集逻辑 <a class="header-anchor" href="#_3、采集逻辑" aria-label="Permalink to &quot;3、采集逻辑&quot;">​</a></h1><ul><li>提交状态（持久化）并拉取控制指令，执行控制指令</li><li>设备客户端推送数据到服务端 ServerDataBaseManager接收</li></ul><h1 id="_4、扩展协议" tabindex="-1">4、扩展协议 <a class="header-anchor" href="#_4、扩展协议" aria-label="Permalink to &quot;4、扩展协议&quot;">​</a></h1><p>集成IotClient开源库，支持大多数设备，可以参考SiemensS7Managerz。</p><ol><li>IotClientService（客户端采集服务业务）包含不同设备的数据采集功能，设备以协议维度进行扩展，扩展步骤如下：</li></ol><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> 实现设备的Manager和Operation,继承 EquipBaseManager</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T,K</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">和IEquipOperation</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">T</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">T是设备采集的dto对象，横向扩展采集属性。</span></span>
<span class="line"><span style="color:#A6ACCD;">K是推送到服务端的dto对象，只推送需要用到的关键属性。</span></span></code></pre></div><ol><li>IotServerService（服务端数据存储业务）包含不同设备的数据仓储，数据以协议维度进行扩展，扩展步骤如下：</li></ol><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;"> 实现数据的DataManager,继承 ServerDataBaseManager</span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;">K</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">K是推送到服务端的dto对象，只推送需要用到的关键属性。</span></span></code></pre></div><h1 id="_5、调度扩展" tabindex="-1">5、调度扩展 <a class="header-anchor" href="#_5、调度扩展" aria-label="Permalink to &quot;5、调度扩展&quot;">​</a></h1><p>调度程序处于IotProcess解决方案文件夹中，服务端通过反射注册服务，并提供接口对外提供数据。</p><div class="language-csharp"><button title="Copy Code" class="copy"></button><span class="lang">csharp</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 设备调度</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">handles</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">types</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Where</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsClass </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsAbstract </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetInterface</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">nameof</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">IServerProcessHandle</span><span style="color:#89DDFF;">))!=null);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">foreach</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">handle</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> handles</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">typeof</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IServerProcessHandle</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> handle</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">//开放数据</span></span>
<span class="line"><span style="color:#A6ACCD;">           </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">processOpen</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> types</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FirstOrDefault</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsClass </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsAbstract </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetInterface</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">nameof</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">IProcessOpenProvider</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">processOpen </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">typeof</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IProcessOpenProvider</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> processOpen</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#89DDFF;">            </span><span style="color:#676E95;font-style:italic;">// 调度入口</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">imple</span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> types</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">FirstOrDefault</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsClass </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsAbstract </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetInterface</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">nameof</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">IServerMainProcess</span><span style="color:#89DDFF;">))</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null);</span></span>
<span class="line"><span style="color:#A6ACCD;">            services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">typeof</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">IServerMainProcess</span><span style="color:#89DDFF;">),</span><span style="color:#A6ACCD;"> imple</span><span style="color:#89DDFF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">injects</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> types</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">Where</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">x</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=&gt;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsClass </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">!</span><span style="color:#A6ACCD;">x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">IsAbstract </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> x</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">EndsWith</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Service</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> StringComparison</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">OrdinalIgnoreCase</span><span style="color:#89DDFF;">));</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">foreach</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">inject</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> injects</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#F78C6C;">var</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">inter</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> inject</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">GetInterface</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">I</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> inject</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">Name</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">inter </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null)</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    services</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">AddSingleton</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">inter</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> inject</span><span style="color:#89DDFF;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">}</span></span></code></pre></div>`,17),e=[p];function t(r,c,D,F,y,C){return a(),n("div",null,e)}const d=s(o,[["render",t]]);export{i as __pageData,d as default};
